<!DOCTYPE html>
<html>
<head>
    <title>Survey</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .step { display: none; }
        .step.active { display: block; }
        .popup { display: block; }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let currentStep = 0;
            const steps = document.querySelectorAll('.step');
            const popup = document.getElementById('popup');

            document.getElementById('start-survey').addEventListener('click', function () {
                popup.style.display = 'none';
                document.getElementById('survey-form').style.display = 'block';
                showStep(0);
            });

            document.getElementById('next-btn').addEventListener('click', function () {
                if (currentStep < steps.length - 1) {
                    showStep(currentStep + 1);
                } else {
                    submitSurvey();
                }
            });

            document.getElementById('prev-btn').addEventListener('click', function () {
                if (currentStep > 0) {
                    showStep(currentStep - 1);
                }
            });

            function showStep(step) {
                steps[currentStep].classList.remove('active');
                currentStep = step;
                steps[currentStep].classList.add('active');
            }

            function submitSurvey() {
                const data = {};
                document.querySelectorAll('.step input:checked').forEach(input => {
                    if (!data[input.name]) data[input.name] = [];
                    data[input.name].push(input.value);
                });
                document.querySelectorAll('.step input[type="radio"]:checked').forEach(input => {
                    data[input.name] = input.value;
                });

                fetch('/survey/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(data)
                }).then(response => response.json()).then(data => {
                    if (data.status === 'success') {
                        alert('Survey submitted successfully!');
                        window.location.href = '/';
                    }
                });
            }

            // Show the first step initially
            showStep(0);
        });
    </script>
</head>
<body>
    <div class="container mt-5">
        <div id="popup" class="popup">
            <h2>Tired of not knowing how to spend money?</h2>
            <p>We can help! Take our survey to get started.</p>
            <button id="start-survey" class="btn btn-primary">Start Survey</button>
        </div>

        <form id="survey-form" style="display: none;">
            {% csrf_token %}
            {% for question, form in forms %}
            <div class="step {% if forloop.first %}active{% endif %}">
                <h3>{{ question }}</h3>
                {{ form.as_p }}
            </div>
            {% endfor %}

            <div class="mt-3 d-flex justify-content-between">
                <button type="button" id="prev-btn" class="btn btn-secondary">Previous</button>
                <button type="button" id="next-btn" class="btn btn-primary">Next</button>
            </div>
        </form>
    </div>
</body>
</html>
